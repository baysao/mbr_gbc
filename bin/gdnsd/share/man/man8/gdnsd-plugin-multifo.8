.\" Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is >0, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{\
.    if \nF \{\
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{\
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "GDNSD-PLUGIN-MULTIFO 8"
.TH GDNSD-PLUGIN-MULTIFO 8 "2023-01-13" "gdnsd 3.8.0" "gdnsd"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
gdnsd\-plugin\-multifo \- gdnsd plugin for multi\-address, all\-active failover
groups
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
Example plugin config:
.PP
.Vb 10
\&  plugins => {
\&    multifo => {
\&      up_thresh => 0.3
\&      service_types => up,
\&      v4www => {
\&        lb01 => 192.0.2.200,
\&        lb02 => 192.0.2.201,
\&        lb03 => 192.0.2.202,
\&      }
\&      v6smtp => {
\&        service_types => [ smtp ],
\&        up_thresh => 0.1,
\&        lb01_v6 => 2001:DB8::1,
\&        lb02_v6 => 2001:DB8::2,
\&        lb03_v6 => 2001:DB8::3,
\&      }
\&      pubwww => {
\&        up_thresh => 0.5
\&        service_types => corpwww_type
\&        addrs_v4 => [ 192.0.2.100, 192.0.2.101, 192.0.2.102 ]
\&        addrs_v6 => {
\&          service_types => [ up ],
\&          up_thresh => 0.7
\&          lb01_v6 => 2001:DB8::1,
\&          lb02_v6 => 2001:DB8::2,
\&          lb03_v6 => 2001:DB8::3,
\&        }
\&      }
\&    }
\&  }
.Ve
.PP
Example zonefile RRs:
.PP
.Vb 3
\&  web4 180 DYNA multifo!v4www
\&  smtp 180 DYNA multifo!v6smtp
\&  www 180 DYNA multifo!pubwww
.Ve
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
\&\fBgdnsd-plugin-multifo\fR is designed to do multi-address all-active
failover grouping.  Basically, for each configured resource name, you supply
a labeled list of addresses.  multifo monitors these addresses
according to \f(CW\*(C`service_types\*(C'\fR, and answers \f(CW\*(C`DYNA\*(C'\fR address queries
using the non\-\f(CW\*(C`DOWN\*(C'\fR subset.  The core gdnsd code will round-robin
rotate the records on the way out, as it does for all address
RR-sets.
.SH "TOP-LEVEL PLUGIN CONFIG"
.IX Header "TOP-LEVEL PLUGIN CONFIG"
At the top level of the plugin's configuration stanza, three special
parameters \f(CW\*(C`up_thresh\*(C'\fR, \f(CW\*(C`service_types\*(C'\fR, and \f(CW\*(C`ignore_health\*(C'\fR are supported.
These set default per-resource options of the same name for any resources which
do not define them explicitly.
.PP
The rest of the hash entries at the top level are the names of the
resources you define.  Each resource gets a configuration hash of its own
for containing resource-specific parameters as well as the actual address
data.
.SH "RESOURCE CONFIG"
.IX Header "RESOURCE CONFIG"
Within a resource, you have two basic options.  You can either directly
specify a set of \f(CW\*(C`label => address\*(C'\fR pairs which are all the same
family (IPv4 or IPv6), or you can use the sub-stanzas \f(CW\*(C`addrs_v4\*(C'\fR and/or
\&\f(CW\*(C`addrs_v6\*(C'\fR to specify one or both families in the same resource.
.PP
The \f(CW\*(C`up_thresh\*(C'\fR, \f(CW\*(C`service_types\*(C'\fR, and \f(CW\*(C`ignore_health\*(C'\fR parameters are
inherited through every level, and can be overridden at any level (even
per-address-family):
.IP "\fBup_thresh\fR" 4
.IX Item "up_thresh"
Floating point, default 0.5, range (0.0 \- 1.0].  This configures the
per-resource \f(CW\*(C`up_thresh\*(C'\fR threshold.  More details in \*(L"\s-1UP THRESH\*(R"\s0 below.
.IP "\fBservice_types\fR" 4
.IX Item "service_types"
Array of strings, or single string.  Default \f(CW\*(C`default\*(C'\fR.  This sets the
monitored service_types for this resource.  If an array of more than one is
provided, all will be monitored for each address, and the net monitored
state will be the minimum (worst) of the set.  See \fBgdnsd.config\fR\|(8) for
more details on service_types.
.IP "\fBignore_health\fR" 4
.IX Item "ignore_health"
Boolean, default false.  If set to true, the health of individual addresses
will not affect whether multifo adds them to the set of output addresses, but
it will still be checked and used for the \f(CW\*(C`up_thresh\*(C'\fR calculation which is
consumed by meta-plugins like geoip and metafo, which might use that
information to fail over to a completely different datacenter as a result.
.SH "SHORTCUT CONFIG"
.IX Header "SHORTCUT CONFIG"
If you have no parameters (service_types, up_thresh, ignore_health) to
configure in a given stanza (single-family direct resource config, or
addrs_v[46]), and do not care about the descriptive per-address labels used in
monitoring, you can replace the hash with an array of addresses.  The labels
will be generated for you as a series of integers starting with \f(CW1\fR.  For
example, the following are equivalent:
.PP
.Vb 2
\&   res1 => { addrs_v4 => [ 192.0.2.1, 192.0.2.2 ] }
\&   res1 => { addrs_v4 => { 1 => 192.0.2.1, 2 => 192.0.2.2 } }
.Ve
.SH "OPERATIONAL MECHANICS"
.IX Header "OPERATIONAL MECHANICS"
All of the addresses for all of the resources are monitored using the
per-address-family inherited \f(CW\*(C`service_types\*(C'\fR specified (default would be
the static virtual monitor \f(CW\*(C`up\*(C'\fR).  When the core daemon
requests a lookup for address records of a given family on one of this
plugin's resources, it goes through essentially the following process to
determine the set of response addresses for that address family: 1) Add all
non-DOWN addresses to the result set.  2) If the set of non-DOWN addresses
fail the up_thresh check, add *all* addresses to the result set as a
fallback.  3) If any address is in the \s-1DOWN\s0 state, cut the
zonefile-specified \s-1TTL\s0 in half.
.PP
If \f(CW\*(C`ignore_health\*(C'\fR is true, all addresses are added to the result set
regardless of health, but the up_thresh and \s-1TTL\s0 effects still happen, and the
final resource-level state still reflects the overall state as it would without
\&\f(CW\*(C`ignore_health\*(C'\fR.
.PP
This process is repeated independently for each of the IPv4 and IPv6
address subsets, in the case that a resource has both address families
configured (the \s-1TTL\s0 is only cut in half once of course).  Details on the
up_thresh check follow:
.SH "UP THRESH"
.IX Header "UP THRESH"
If there are not enough \s-1UP\s0 addresses to pass the threshold (per address family),
all addresses (of a given address family) will be returned as a fallback.
.PP
The threshold is implemented mathematically as in the following pseudo-code
\&\f(CW\*(C`if(non_down >= ceil(thresh * total)) threshold_passed;\*(C'\fR.  For
example, if thresh is at the default value of \f(CW0.5\fR, and there are 3 total
IPv4 addresses, then 2 of them must be non-down to pass the threshold.  The
net result is that with the default threshold, the plugin will never return
an isolated single address from a set of 3.  It will either return all 3,
or it will return 2/3 if a single address from the set has failed.
.PP
When the threshold check fails (and all addresses are returned) for either
address family, resource-level total failure will also be signaled to any
applicable upstream meta-plugins such as metafo or geoip.
.PP
General rules for the results of the up_thresh formula:
.IP "\(bu" 4
A threshold of 1.0 will only pass if \fBall\fR addresses are not-down.
This is mostly pointless, you might as well not monitor anything and set
up these addresses as a static set in a zonefile.
.IP "\(bu" 4
A threshold of 0.01 will pass even if only one address is alive and
return just that one address, even if it's e.g. the only one left out of 40.
.IP "\(bu" 4
Because a threshold of 0.0 is illegal, if all addresses are down
the threshold will always fail, returning all addresses.
.PP
Intermediate value examples: (threshold: non\-down/total required to pass
threshold):
.IP "\(bu" 4
0.1: 1/1 1/2 1/3 1/4 1/5 1/6 1/7 1/8 2/16
.IP "\(bu" 4
0.2: 1/1 1/2 1/3 1/4 1/5 2/6 2/7 2/8 4/16
.IP "\(bu" 4
0.3: 1/1 1/2 1/3 2/4 2/5 2/6 3/7 3/8 5/16
.IP "\(bu" 4
0.4: 1/1 1/2 2/3 2/4 2/5 3/6 3/7 4/8 7/16
.IP "\(bu" 4
0.5: 1/1 1/2 2/3 2/4 3/5 3/6 4/7 4/8 8/16
.IP "\(bu" 4
0.6: 1/1 2/2 2/3 3/4 3/5 4/6 5/7 5/8 10/16
.IP "\(bu" 4
0.7: 1/1 2/2 3/3 3/4 4/5 5/6 5/7 6/8 12/16
.IP "\(bu" 4
0.8: 1/1 2/2 3/3 4/4 4/5 5/6 6/7 7/8 13/16
.IP "\(bu" 4
0.9: 1/1 2/2 3/3 4/4 5/5 6/6 7/7 8/8 15/16
.SH "SEE ALSO"
.IX Header "SEE ALSO"
\&\fBgdnsd.config\fR\|(5), \fBgdnsd.zonefile\fR\|(5), \fBgdnsd\fR\|(8),
\&\fBgdnsd\-plugin\-simplefo\fR\|(8)
.PP
The gdnsd manual.
.SH "COPYRIGHT AND LICENSE"
.IX Header "COPYRIGHT AND LICENSE"
Copyright (c) 2012 Brandon L Black <blblack@gmail.com>
.PP
This file is part of gdnsd.
.PP
gdnsd is free software: you can redistribute it and/or modify
it under the terms of the \s-1GNU\s0 General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
.PP
gdnsd is distributed in the hope that it will be useful,
but \s-1WITHOUT ANY WARRANTY\s0; without even the implied warranty of
\&\s-1MERCHANTABILITY\s0 or \s-1FITNESS FOR A PARTICULAR PURPOSE.\s0  See the
\&\s-1GNU\s0 General Public License for more details.
.PP
You should have received a copy of the \s-1GNU\s0 General Public License
along with gdnsd.  If not, see <http://www.gnu.org/licenses/>.
